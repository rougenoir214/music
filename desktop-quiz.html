<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ›²å½“ã¦ã‚¯ã‚¤ã‚º - ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-cyan-teal {
            background: linear-gradient(135deg, #06b6d4 0%, #14b8a6 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .animate-bounce-in {
            animation: bounceIn 0.5s ease;
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .progress-bar {
            transition: width 0.1s linear;
        }
        
        /* ã‚¹ã‚³ã‚¢æ›´æ–°æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .score-update {
            animation: scoreFlash 0.6s ease;
        }
        
        @keyframes scoreFlash {
            0% { background-color: rgba(255, 255, 255, 0.2); }
            50% { background-color: rgba(34, 197, 94, 0.6); transform: scale(1.05); }
            100% { background-color: rgba(255, 255, 255, 0.2); }
        }
    </style>
</head>
<body class="gradient-cyan-teal min-h-screen">
    <!-- ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ï¼ˆéè¡¨ç¤ºï¼‰ -->
    <audio id="audioPlayer" preload="auto"></audio>
    
    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="container mx-auto px-4 py-6 max-w-4xl">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="text-center mb-8">
            <h1 class="text-5xl font-black text-white mb-3 drop-shadow-lg">
                ğŸµ æ›²å½“ã¦ã‚¯ã‚¤ã‚º
            </h1>
            <p class="text-lg text-white/90 drop-shadow">Apple Music ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç‰ˆ</p>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
        <div id="app">
            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ç”»é¢ -->
            <div id="userManagement" class="space-y-6">
                <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç† -->
                <div class="glass-effect rounded-3xl p-6 shadow-2xl">
                    <h2 class="text-3xl font-bold text-white mb-4 flex items-center gap-3">
                        <span class="text-4xl">ğŸ‘¥</span>
                        ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†
                    </h2>
                    
                    <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
                    <div class="mb-6 flex gap-3">
                        <input 
                            type="text" 
                            id="playerName" 
                            placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›"
                            class="flex-1 px-4 py-3 rounded-xl text-lg focus:outline-none focus:ring-4 focus:ring-cyan-400/50"
                        />
                        <button 
                            onclick="addPlayer()"
                            class="bg-white text-cyan-600 px-8 py-3 rounded-xl font-bold text-lg hover:bg-cyan-50 transition-all transform hover:scale-105 shadow-lg"
                        >
                            è¿½åŠ 
                        </button>
                    </div>
                    
                    <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆ -->
                    <div id="playerList" class="space-y-3"></div>
                    
                    <!-- æˆç¸¾ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
                    <button 
                        onclick="resetScores()"
                        class="mt-4 w-full bg-red-500/80 text-white px-6 py-3 rounded-xl font-bold hover:bg-red-600 transition-all"
                    >
                        ğŸ”„ å…¨æˆç¸¾ã‚’ãƒªã‚»ãƒƒãƒˆ
                    </button>
                </div>

                <!-- æ›²ç®¡ç† -->
                <div class="glass-effect rounded-3xl p-6 shadow-2xl">
                    <h2 class="text-3xl font-bold text-white mb-4 flex items-center gap-3">
                        <span class="text-4xl">ğŸµ</span>
                        æ›²ã‚’è¿½åŠ 
                    </h2>
                    
                    <!-- æ¤œç´¢ã‚¿ã‚¤ãƒ—é¸æŠ -->
                    <div class="mb-4 flex gap-2">
                        <button 
                            id="artistSearchBtn"
                            onclick="setSearchType('artist')"
                            class="flex-1 bg-white/30 text-white px-4 py-2 rounded-xl font-bold hover:bg-white/40 transition-all"
                        >
                            ğŸ‘¤ ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆæ¤œç´¢
                        </button>
                        <button 
                            id="songSearchBtn"
                            onclick="setSearchType('song')"
                            class="flex-1 bg-white/20 text-white px-4 py-2 rounded-xl font-bold hover:bg-white/40 transition-all"
                        >
                            ğŸµ æ›²åæ¤œç´¢
                        </button>
                    </div>
                    
                    <!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  -->
                    <div class="mb-4 flex gap-3">
                        <input 
                            type="text" 
                            id="searchQuery" 
                            placeholder="ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã‚’å…¥åŠ›"
                            class="flex-1 px-4 py-3 rounded-xl text-lg focus:outline-none focus:ring-4 focus:ring-cyan-400/50"
                        />
                        <button 
                            onclick="searchSongs()"
                            class="bg-white text-cyan-600 px-8 py-3 rounded-xl font-bold text-lg hover:bg-cyan-50 transition-all transform hover:scale-105 shadow-lg"
                        >
                            ğŸ” æ¤œç´¢
                        </button>
                    </div>
                    
                    <!-- ãƒ†ãƒ¼ãƒåˆ¥ã‚¯ã‚¤ã‚ºãƒœã‚¿ãƒ³ -->
                    <div class="mb-6">
                        <h3 class="text-white font-bold mb-3 text-lg">ğŸ“… å¹´ä»£åˆ¥J-POP</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4">
                            <button 
                                onclick="startDecadeQuiz(1980, 1989)"
                                class="bg-gradient-to-r from-pink-500 to-rose-500 text-white px-4 py-3 rounded-xl font-bold hover:shadow-xl transition-all transform hover:scale-105"
                            >
                                ğŸ¸ 1980å¹´ä»£
                            </button>
                            <button 
                                onclick="startDecadeQuiz(1990, 1999)"
                                class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-3 rounded-xl font-bold hover:shadow-xl transition-all transform hover:scale-105"
                            >
                                ğŸ’¿ 1990å¹´ä»£
                            </button>
                            <button 
                                onclick="startDecadeQuiz(2000, 2009)"
                                class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-4 py-3 rounded-xl font-bold hover:shadow-xl transition-all transform hover:scale-105"
                            >
                                ğŸµ 2000å¹´ä»£
                            </button>
                            <button 
                                onclick="startDecadeQuiz(2010, 2019)"
                                class="bg-gradient-to-r from-blue-500 to-cyan-500 text-white px-4 py-3 rounded-xl font-bold hover:shadow-xl transition-all transform hover:scale-105"
                            >
                                ğŸ¤ 2010å¹´ä»£
                            </button>
                            <button 
                                onclick="startDecadeQuiz(2020, 2025)"
                                class="bg-gradient-to-r from-cyan-500 to-teal-500 text-white px-4 py-3 rounded-xl font-bold hover:shadow-xl transition-all transform hover:scale-105"
                            >
                                ğŸŒŸ 2020å¹´ä»£
                            </button>
                        </div>
                        
                        <h3 class="text-white font-bold mb-3 text-lg">ğŸ­ ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button 
                                onclick="startThemeQuiz('ã‚¢ãƒ‹ãƒ¡ã‚½ãƒ³ã‚°')"
                                class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-4 py-3 rounded-xl font-bold hover:shadow-xl transition-all transform hover:scale-105"
                            >
                                ğŸ¬ ã‚¢ãƒ‹ãƒ¡ã‚½ãƒ³ã‚°
                            </button>
                            <button 
                                onclick="startThemeQuiz('ç«¥è¬¡')"
                                class="bg-gradient-to-r from-yellow-400 to-amber-500 text-white px-4 py-3 rounded-xl font-bold hover:shadow-xl transition-all transform hover:scale-105"
                            >
                                ğŸ‘¶ ç«¥è¬¡
                            </button>
                            <button 
                                onclick="startThemeQuiz('æ¼”æ­Œ')"
                                class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-3 rounded-xl font-bold hover:shadow-xl transition-all transform hover:scale-105"
                            >
                                ğŸ¤ æ¼”æ­Œ
                            </button>
                        </div>
                    </div>
                    
                    <!-- æ¤œç´¢çµæœ -->
                    <div id="searchResults" class="space-y-2 mb-4 max-h-96 overflow-y-auto"></div>
                    
                    <!-- é¸æŠã—ãŸæ›²ãƒªã‚¹ãƒˆ -->
                    <h3 class="text-xl font-bold text-white mb-3 mt-6">é¸æŠã—ãŸæ›²ï¼ˆ<span id="songCount">0</span>æ›²ï¼‰</h3>
                    <div id="selectedSongsList" class="space-y-2 max-h-64 overflow-y-auto"></div>
                    <button 
                        onclick="clearSelectedSongs()" 
                        class="mt-4 w-full bg-red-500/80 hover:bg-red-500 text-white px-6 py-3 rounded-xl font-bold transition-all"
                    >
                        ğŸ—‘ï¸ é¸æŠã—ãŸæ›²ã‚’ã‚¯ãƒªã‚¢
                    </button>
                    
                    <!-- æ›²ãƒªã‚¹ãƒˆä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ -->
                    <div class="mt-3 grid grid-cols-2 gap-3">
                        <button 
                            onclick="saveSongList()"
                            class="bg-blue-500/80 hover:bg-blue-500 text-white px-6 py-3 rounded-xl font-bold transition-all"
                        >
                            ğŸ’¾ æ›²ãƒªã‚¹ãƒˆã‚’ä¿å­˜
                        </button>
                        <label class="bg-green-500/80 hover:bg-green-500 text-white px-6 py-3 rounded-xl font-bold transition-all cursor-pointer text-center">
                            ğŸ“‚ æ›²ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
                            <input 
                                type="file" 
                                id="loadSongListFile" 
                                accept=".json"
                                onchange="loadSongList(event)"
                                class="hidden"
                            />
                        </label>
                    </div>
                </div>

                <!-- ã‚¯ã‚¤ã‚ºè¨­å®š -->
                <div class="glass-effect rounded-3xl p-6 shadow-2xl">
                    <h2 class="text-3xl font-bold text-white mb-4">âš™ï¸ ã‚¯ã‚¤ã‚ºè¨­å®š</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-white font-bold mb-2 text-lg">
                                å†ç”Ÿæ™‚é–“: <span id="introLengthValue">3</span>ç§’
                            </label>
                            <input 
                                type="range" 
                                id="introLength" 
                                min="1" 
                                max="10" 
                                value="3"
                                oninput="updateIntroLength(this.value)"
                                class="w-full h-3 bg-white/30 rounded-lg appearance-none cursor-pointer"
                            />
                        </div>
                    </div>
                    
                    <button 
                        onclick="startQuiz()"
                        class="mt-6 w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-8 py-4 rounded-xl font-black text-2xl hover:shadow-2xl transition-all transform hover:scale-105"
                    >
                        ğŸ® ã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆï¼
                    </button>
                </div>
            </div>

            <!-- ã‚¯ã‚¤ã‚ºç”»é¢ -->
            <div id="quizGame" class="hidden space-y-6">
                <!-- ç¾åœ¨ã®ã‚¹ã‚³ã‚¢ï¼ˆä¸Šéƒ¨ã«å›ºå®šè¡¨ç¤ºï¼‰ -->
                <div class="glass-effect rounded-3xl p-4 shadow-2xl">
                    <h3 class="text-xl font-bold text-white mb-3 text-center">ğŸ“Š ç¾åœ¨ã®ã‚¹ã‚³ã‚¢</h3>
                    <div id="currentScores" class="grid grid-cols-2 md:grid-cols-4 gap-2"></div>
                </div>

                <!-- é€²æ—è¡¨ç¤º -->
                <div class="glass-effect rounded-3xl p-6 shadow-2xl">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-white font-bold text-xl">å•é¡Œ <span id="currentQuestion">1</span> / <span id="totalQuestions">10</span></span>
                        <span class="text-white font-bold text-xl">â±ï¸ <span id="timer">0</span>ç§’</span>
                    </div>
                    <div class="w-full bg-white/30 rounded-full h-4">
                        <div id="progressBar" class="progress-bar bg-yellow-400 h-4 rounded-full" style="width: 0%"></div>
                    </div>
                </div>

                <!-- æ›²æƒ…å ± -->
                <div class="glass-effect rounded-3xl p-8 shadow-2xl text-center">
                    <div class="text-6xl mb-4">ğŸµ</div>
                    <h3 class="text-3xl font-black text-white mb-4">ã“ã®æ›²ã¯ä½•ã§ã—ã‚‡ã†ï¼Ÿ</h3>
                    
                    <!-- ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ï¼ˆæœ€åˆã ã‘è¡¨ç¤ºï¼‰ -->
                    <button 
                        id="startMusicBtn"
                        onclick="startMusic()"
                        class="w-full max-w-md mx-auto bg-gradient-to-r from-green-400 to-emerald-500 text-white px-8 py-6 rounded-xl font-black text-3xl hover:shadow-2xl transition-all transform hover:scale-105 mb-4"
                    >
                        â–¶ï¸ æ›²ã‚’å†ç”Ÿã™ã‚‹
                    </button>
                    
                    <!-- å†ç”Ÿã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
                    <div id="musicControls" class="hidden">
                        <div class="flex gap-3 justify-center mb-4">
                            <button 
                                onclick="playIntro()"
                                class="bg-green-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-green-600 transition-all transform hover:scale-105"
                            >
                                ğŸ”Š å†ç”Ÿ
                            </button>
                            <button 
                                onclick="stopAudio()"
                                class="bg-red-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-red-600 transition-all transform hover:scale-105"
                            >
                                â¸ï¸ åœæ­¢
                            </button>
                            <button 
                                id="playFullBtn"
                                onclick="playFull()"
                                class="bg-blue-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-600 transition-all transform hover:scale-105 hidden"
                            >
                                ğŸµ å…¨æ›²å†ç”Ÿ
                            </button>
                        </div>
                    </div>
                    
                    <p id="currentSongTitle" class="text-2xl text-white font-bold hidden mt-4"></p>
                </div>

                <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒœã‚¿ãƒ³ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div id="playerButtons"></div>
                </div>

                <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
                <div class="grid grid-cols-3 gap-4">
                    <button 
                        onclick="showAnswerOnly()"
                        class="glass-effect text-white px-6 py-4 rounded-xl font-bold text-lg hover:bg-white/30 transition-all"
                    >
                        ğŸ‘ï¸ ç­”ãˆã‚’è¦‹ã‚‹
                    </button>
                    <button 
                        onclick="playFullAnswer()"
                        class="glass-effect text-white px-6 py-4 rounded-xl font-bold text-lg hover:bg-white/30 transition-all"
                    >
                        ğŸµ å…¨æ›²å†ç”Ÿ
                    </button>
                    <button 
                        onclick="nextQuestion()"
                        class="bg-white text-cyan-600 px-6 py-4 rounded-xl font-bold text-lg hover:bg-cyan-50 transition-all"
                    >
                        â¡ï¸ æ¬¡ã®å•é¡Œ
                    </button>
                </div>

            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let players = JSON.parse(localStorage.getItem('quizPlayers') || '[]');
        let scores = JSON.parse(localStorage.getItem('quizScores') || '{}');
        let selectedSongs = JSON.parse(localStorage.getItem('quizSelectedSongs') || '[]');
        let currentQuestionIndex = 0;
        let introLength = 3;
        let audioPlayer = document.getElementById('audioPlayer');
        let playbackTimer = null;
        let startTime = 0;
        let searchType = 'artist';

        // åˆæœŸåŒ–
        renderPlayerList();
        setSearchType('artist');
        updateSelectedSongsList(); // ä¿å­˜ã•ã‚ŒãŸæ›²ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        
        // JSONPæ–¹å¼ã§iTunes APIã«ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆå®‰å®šæ€§å‘ä¸Šï¼‰
        function fetchJsonp(url, timeout = 60000) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_' + Date.now() + '_' + Math.random().toString(36).substr(2);
                const script = document.createElement('script');
                let timeoutId;

                window[callbackName] = function(data) {
                    clearTimeout(timeoutId);
                    delete window[callbackName];
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    resolve(data);
                };

                timeoutId = setTimeout(() => {
                    delete window[callbackName];
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    reject(new Error('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ60ç§’ï¼‰'));
                }, timeout);

                script.onerror = () => {
                    clearTimeout(timeoutId);
                    delete window[callbackName];
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    reject(new Error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'));
                };

                script.src = url + '&callback=' + callbackName;
                document.head.appendChild(script);
            });
        }

        // æ¤œç´¢ã‚¿ã‚¤ãƒ—ã‚’è¨­å®š
        function setSearchType(type) {
            searchType = type;
            const artistBtn = document.getElementById('artistSearchBtn');
            const songBtn = document.getElementById('songSearchBtn');
            const searchInput = document.getElementById('searchQuery');
            
            if (type === 'artist') {
                artistBtn.classList.remove('bg-white/20');
                artistBtn.classList.add('bg-white/30');
                songBtn.classList.remove('bg-white/30');
                songBtn.classList.add('bg-white/20');
                searchInput.placeholder = 'ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã‚’å…¥åŠ›';
            } else {
                songBtn.classList.remove('bg-white/20');
                songBtn.classList.add('bg-white/30');
                artistBtn.classList.remove('bg-white/30');
                artistBtn.classList.add('bg-white/20');
                searchInput.placeholder = 'æ›²åã‚’å…¥åŠ›';
            }
            
            document.getElementById('searchResults').innerHTML = '';
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ 
        function addPlayer() {
            const nameInput = document.getElementById('playerName');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (players.length >= 4) {
                alert('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯æœ€å¤§4äººã¾ã§ã§ã™');
                return;
            }
            
            const player = {
                id: Date.now(),
                name: name
            };
            
            players.push(player);
            scores[player.id] = scores[player.id] || 0;
            
            savePlayers();
            saveScores();
            renderPlayerList();
            
            nameInput.value = '';
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤
        function removePlayer(id) {
            players = players.filter(p => p.id !== id);
            delete scores[id];
            savePlayers();
            saveScores();
            renderPlayerList();
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆè¡¨ç¤º
        function renderPlayerList() {
            const listDiv = document.getElementById('playerList');
            
            if (players.length === 0) {
                listDiv.innerHTML = '<p class="text-white/70 text-center py-4">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>';
                return;
            }
            
            listDiv.innerHTML = players.map(player => `
                <div class="bg-white/20 rounded-xl p-4 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">ğŸ‘¤</span>
                        <div>
                            <div class="text-white font-bold text-lg">${player.name}</div>
                            <div class="text-white/80 text-sm">ã‚¹ã‚³ã‚¢: ${scores[player.id] || 0}ãƒã‚¤ãƒ³ãƒˆ</div>
                        </div>
                    </div>
                    <button 
                        onclick="removePlayer(${player.id})"
                        class="bg-red-500/80 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-600 transition-all"
                    >
                        âœ•
                    </button>
                </div>
            `).join('');
        }

        // iTunes Search APIã§æ›²ã‚’æ¤œç´¢ï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã¯åˆ¶é™ãªã—ï¼‰
        async function searchSongs() {
            const query = document.getElementById('searchQuery').value.trim();
            
            if (!query) {
                alert('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<p class="text-white text-center py-4">ğŸ” æ¤œç´¢ä¸­...</p>';
            
            try {
                // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã¯100ä»¶ã¾ã§å–å¾—å¯èƒ½
                const url = `https://itunes.apple.com/search?term=${encodeURIComponent(query)}&media=music&limit=100&country=JP`;
                
                console.log('æ¤œç´¢URL:', url);
                
                const data = await fetchJsonp(url);
                
                console.log('æ¤œç´¢çµæœ:', data);
                
                if (!data.results || data.results.length === 0) {
                    resultsDiv.innerHTML = '<p class="text-white text-center py-4">æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }
                
                const songsWithPreview = data.results.filter(song => song.previewUrl);
                
                if (songsWithPreview.length === 0) {
                    resultsDiv.innerHTML = '<p class="text-white text-center py-4">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯èƒ½ãªæ›²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
                    return;
                }
                
                if (searchType === 'artist') {
                    displayArtistResults(songsWithPreview);
                } else {
                    displaySongResults(songsWithPreview);
                }
                
            } catch (error) {
                console.error('æ¤œç´¢ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
                resultsDiv.innerHTML = `
                    <div class="bg-red-500/30 rounded-xl p-4 text-white">
                        <p class="font-bold mb-2">âŒ æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
                        <p class="text-sm mb-3">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                        <button 
                            onclick="searchSongs()"
                            class="w-full bg-white/20 text-white px-4 py-2 rounded-lg font-bold hover:bg-white/30"
                        >
                            ğŸ”„ å†è©¦è¡Œ
                        </button>
                    </div>
                `;
            }
        }
        
        // ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆæ¤œç´¢ã®çµæœã‚’è¡¨ç¤º
        function displayArtistResults(songs) {
            const resultsDiv = document.getElementById('searchResults');
            const searchQuery = document.getElementById('searchQuery').value.trim().toLowerCase();
            
            const artistMap = {};
            songs.forEach(song => {
                if (song.artistName.toLowerCase().includes(searchQuery)) {
                    if (!artistMap[song.artistId]) {
                        artistMap[song.artistId] = {
                            artistName: song.artistName,
                            artistId: song.artistId,
                            songs: []
                        };
                    }
                    artistMap[song.artistId].songs.push(song);
                }
            });
            
            const artists = Object.values(artistMap);
            
            if (artists.length === 0) {
                resultsDiv.innerHTML = '<p class="text-white text-center py-4">è©²å½“ã™ã‚‹ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
                return;
            }
            
            artists.sort((a, b) => b.songs.length - a.songs.length);
            
            resultsDiv.innerHTML = artists.map(artist => `
                <div class="bg-white/20 rounded-xl p-4 mb-3">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex-1">
                            <div class="text-white font-bold text-lg">ğŸ‘¤ ${artist.artistName}</div>
                            <div class="text-white/80 text-sm">${artist.songs.length}æ›²è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ</div>
                        </div>
                        <button 
                            onclick='startArtistQuiz(${JSON.stringify(artist.songs).replace(/'/g, "&apos;")})'
                            class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2 rounded-lg font-bold hover:shadow-xl transition-all"
                        >
                            ğŸ® ã‚¯ã‚¤ã‚ºé–‹å§‹
                        </button>
                    </div>
                    
                    <details class="mt-2">
                        <summary class="text-white/90 cursor-pointer hover:text-white text-sm font-bold mb-2">
                            ğŸ“‹ æ›²ä¸€è¦§ã‚’è¡¨ç¤ºï¼ˆ${artist.songs.length}æ›²ï¼‰
                        </summary>
                        <div class="mt-2 space-y-2 max-h-64 overflow-y-auto">
                            ${artist.songs.map(song => `
                                <div class="bg-white/10 rounded-lg p-2 flex items-center gap-2 hover:bg-white/20 transition-all">
                                    <img src="${song.artworkUrl60}" alt="${song.trackName}" class="w-12 h-12 rounded" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22%3E%3Crect fill=%22%23ccc%22 width=%2260%22 height=%2260%22/%3E%3C/svg%3E'" />
                                    <div class="flex-1 min-w-0">
                                        <div class="text-white font-bold text-sm truncate">${song.trackName}</div>
                                        <div class="text-white/70 text-xs truncate">${song.collectionName || 'ã‚¢ãƒ«ãƒãƒ æƒ…å ±ãªã—'}</div>
                                    </div>
                                    <button 
                                        onclick='addSong(${JSON.stringify(song).replace(/'/g, "&apos;")})'
                                        class="bg-cyan-500 text-white px-3 py-1 rounded-lg font-bold hover:bg-cyan-600 transition-all text-sm flex-shrink-0"
                                    >
                                        â•
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </details>
                </div>
            `).join('');
        }
        
        // æ›²åæ¤œç´¢ã®çµæœã‚’è¡¨ç¤º
        function displaySongResults(songs) {
            const resultsDiv = document.getElementById('searchResults');
            
            resultsDiv.innerHTML = songs.map(song => `
                <div class="bg-white/20 rounded-xl p-3 flex items-center gap-3 hover:bg-white/30 transition-all cursor-pointer" onclick='addSong(${JSON.stringify(song).replace(/'/g, "&apos;")})'>
                    <img src="${song.artworkUrl60}" alt="${song.trackName}" class="w-16 h-16 rounded-lg" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22%3E%3Crect fill=%22%23ccc%22 width=%2260%22 height=%2260%22/%3E%3C/svg%3E'" />
                    <div class="flex-1 min-w-0">
                        <div class="text-white font-bold truncate">${song.trackName}</div>
                        <div class="text-white/80 text-sm truncate">${song.artistName}</div>
                    </div>
                    <button class="bg-cyan-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-cyan-600 transition-all">
                        â•
                    </button>
                </div>
            `).join('');
        }
        
        // ãƒ†ãƒ¼ãƒåˆ¥ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹
        async function startThemeQuiz(theme) {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = `<p class="text-white text-center py-4">ğŸ” ã€Œ${theme}ã€ã‚’æ¤œç´¢ä¸­...</p>`;
            
            try {
                let allSongs = [];
                
                // ç«¥è¬¡ã¯è¤‡æ•°ã®å…·ä½“çš„ãªæ›²åã§æ¤œç´¢
                if (theme === 'ç«¥è¬¡') {
                    const childrenSongs = [
                        'ãã†ã•ã‚“', 'ãƒãƒ¥ãƒ¼ãƒªãƒƒãƒ—', 'ã©ã‚“ãã‚Šã“ã‚ã“ã‚', 'ã‹ãŸã¤ã‚€ã‚Š',
                        'ã¡ã‚‡ã†ã¡ã‚‡ã†', 'ã‚€ã™ã‚“ã§ã²ã‚‰ã„ã¦', 'ãã‚‰ãã‚‰æ˜Ÿ', 'ã‚‚ã‚‚ãŸã‚ã†',
                        'ã†ã•ãã¨ã‹ã‚', 'ã“ã„ã®ã¼ã‚Š', 'ã—ã‚ƒã¼ã‚“ç‰', 'ã‚ã‚ãµã‚Š',
                        'ã†ã¿', 'ã¯ã¨', 'ã‚†ã', 'ãŸãªã°ãŸã•ã¾',
                        'ãŠãŠããªãã‚Šã®ãã®ã—ãŸã§', 'ãŠã‚‚ã¡ã‚ƒã®ãƒãƒ£ãƒãƒ£ãƒãƒ£'
                    ];
                    
                    // è¤‡æ•°ã®ç«¥è¬¡ã‚’æ¤œç´¢
                    for (const songName of childrenSongs) {
                        const url = `https://itunes.apple.com/search?term=${encodeURIComponent(songName + ' ç«¥è¬¡')}&media=music&limit=10&country=JP`;
                        try {
                            const data = await fetchJsonp(url, 10000);
                            const validSongs = data.results.filter(song => {
                                if (!song.previewUrl) return false;
                                
                                // ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã§ç«¥è¬¡ã‹ãƒã‚§ãƒƒã‚¯
                                const artist = song.artistName.toLowerCase();
                                
                                // ç«¥è¬¡ã‚‰ã—ã„ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
                                const validKeywords = ['ç«¥è¬¡', 'ã“ã©ã‚‚', 'å­ä¾›', 'å­ã©ã‚‚', 'åˆå”±', 'å”±æ­Œ', 'ã‚ˆã†ã¡ãˆã‚“', 'å¹¼ç¨šåœ’'];
                                const hasValidKeyword = validKeywords.some(keyword => artist.includes(keyword));
                                
                                // NGã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆï¼ˆJ-POPã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆï¼‰
                                const ngArtists = ['lisa', 'back number', 'yoasobi', 'ado', 'official', 'millennium parade', 'ã‚­ãƒ³ã‚°ãƒ»ã‚¯ãƒªãƒ ã‚¾ãƒ³'];
                                const isNgArtist = ngArtists.some(ng => artist.includes(ng));
                                
                                return hasValidKeyword && !isNgArtist;
                            });
                            allSongs = allSongs.concat(validSongs);
                        } catch (error) {
                            console.log(`${songName}ã®æ¤œç´¢ã§ã‚¨ãƒ©ãƒ¼:`, error);
                        }
                    }
                    
                } else if (theme === 'ã‚¢ãƒ‹ãƒ¡ã‚½ãƒ³ã‚°') {
                    // ã‚¢ãƒ‹ãƒ¡ã‚½ãƒ³ã‚°ã‚‚å…·ä½“çš„ãªæ›²åã§æ¤œç´¢
                    const animeSongs = [
                        'æ®‹é…·ãªå¤©ä½¿ã®ãƒ†ãƒ¼ã‚¼', 'ã‚¿ãƒƒãƒ', 'ãƒ«ãƒ‘ãƒ³ä¸‰ä¸–', 'ç´…è“®è¯',
                        'ç‚', 'ã‚¢ãƒ³ãƒ‘ãƒ³ãƒãƒ³ã®ãƒãƒ¼ãƒ', 'ãƒ‰ãƒ©ãˆã‚‚ã‚“ã®ã†ãŸ', 'ã‚µã‚¶ã‚¨ã•ã‚“',
                        'ãŠã©ã‚‹ãƒãƒ³ãƒã‚³ãƒªãƒ³', 'ã‚²ã‚²ã‚²ã®é¬¼å¤ªéƒ', 'ã‚ã–ã›ãƒã‚±ãƒ¢ãƒ³ãƒã‚¹ã‚¿ãƒ¼',
                        'ãƒ ãƒ¼ãƒ³ãƒ©ã‚¤ãƒˆä¼èª¬', 'ã‚¿ãƒƒãƒ', 'å®‡å®™æˆ¦è‰¦ãƒ¤ãƒãƒˆ', 'ãƒã‚¸ãƒ³ã‚¬ãƒ¼Z',
                        'CAT\'S EYE', 'ç´…', 'ã‚·ãƒ«ã‚¨ãƒƒãƒˆ', 'ã‚¤ãƒ³ãƒ•ã‚§ãƒ«ãƒ', 'åƒæœ¬æ¡œ'
                    ];
                    
                    for (const songName of animeSongs) {
                        const url = `https://itunes.apple.com/search?term=${encodeURIComponent(songName + ' ã‚¢ãƒ‹ãƒ¡')}&media=music&limit=10&country=JP`;
                        try {
                            const data = await fetchJsonp(url, 10000);
                            const validSongs = data.results.filter(song => song.previewUrl);
                            allSongs = allSongs.concat(validSongs);
                        } catch (error) {
                            console.log(`${songName}ã®æ¤œç´¢ã§ã‚¨ãƒ©ãƒ¼:`, error);
                        }
                    }
                    
                } else if (theme === 'æ¼”æ­Œ') {
                    // æ¼”æ­Œã¯æœ‰åãªæ¼”æ­Œæ­Œæ‰‹ã§æ¤œç´¢
                    const enkaArtists = [
                        'çŸ³å·ã•ã‚†ã‚Š', 'æ°·å·ãã‚ˆã—', 'åŒ—å³¶ä¸‰éƒ', 'äº”æœ¨ã²ã‚ã—',
                        'å‚æœ¬å†¬ç¾', 'ç´°å·ãŸã‹ã—', 'æ£®é€²ä¸€', 'æ£®æ˜Œå­',
                        'å…«ä»£äºœç´€', 'å°æ—å¹¸å­', 'ç¾ç©ºã²ã°ã‚Š', 'éƒ½ã¯ã‚‹ã¿'
                    ];
                    
                    for (const artist of enkaArtists) {
                        const url = `https://itunes.apple.com/search?term=${encodeURIComponent(artist)}&media=music&limit=20&country=JP`;
                        try {
                            const data = await fetchJsonp(url, 10000);
                            const validSongs = data.results.filter(song => song.previewUrl);
                            allSongs = allSongs.concat(validSongs);
                        } catch (error) {
                            console.log(`${artist}ã®æ¤œç´¢ã§ã‚¨ãƒ©ãƒ¼:`, error);
                        }
                    }
                    
                } else {
                    // ãã®ä»–ã®ãƒ†ãƒ¼ãƒã¯å¾“æ¥é€šã‚Š
                    const searchTerm = `${theme} æ—¥æœ¬`;
                    const url = `https://itunes.apple.com/search?term=${encodeURIComponent(searchTerm)}&media=music&limit=50&country=JP`;
                    
                    console.log('ãƒ†ãƒ¼ãƒæ¤œç´¢URL:', url);
                    
                    const data = await fetchJsonp(url);
                    
                    console.log('ãƒ†ãƒ¼ãƒæ¤œç´¢çµæœ:', data);
                    
                    allSongs = data.results.filter(song => song.previewUrl);
                }
                
                // é‡è¤‡ã‚’å‰Šé™¤
                const uniqueSongs = allSongs.filter((song, index, self) =>
                    index === self.findIndex(s => s.trackId === song.trackId)
                );
                
                console.log(`${theme}: ${uniqueSongs.length}æ›²è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);
                
                if (uniqueSongs.length === 0) {
                    alert(`${theme}ã®æ›²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
                    resultsDiv.innerHTML = '';
                    return;
                }
                
                // æ¤œç´¢çµæœã‚’è¡¨ç¤ºï¼ˆè¿½åŠ ãƒœã‚¿ãƒ³ä»˜ãï¼‰
                displayThemeResults(uniqueSongs, theme);
                
            } catch (error) {
                console.error('ãƒ†ãƒ¼ãƒæ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                alert(`æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}\n\nåˆ¥ã®ãƒ†ãƒ¼ãƒã‚’è©¦ã—ã¦ãã ã•ã„ã€‚`);
                resultsDiv.innerHTML = '';
            }
        }
        
        // ãƒ†ãƒ¼ãƒæ¤œç´¢çµæœã‚’è¡¨ç¤º
        function displayThemeResults(songs, theme) {
            const resultsDiv = document.getElementById('searchResults');
            
            resultsDiv.innerHTML = `
                <div class="mb-4">
                    <p class="text-white text-center py-2">âœ… ${theme}ã‹ã‚‰${songs.length}æ›²è¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼</p>
                    <p class="text-white/70 text-sm text-center">æ›²ã‚’ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯â•ãƒœã‚¿ãƒ³ã§è¿½åŠ ã§ãã¾ã™</p>
                </div>
                ${songs.map(song => `
                    <div class="bg-white/20 rounded-xl p-3 flex items-center gap-3 hover:bg-white/30 transition-all cursor-pointer" onclick='addSong(${JSON.stringify(song).replace(/'/g, "&apos;")})'>
                        <img src="${song.artworkUrl60}" alt="${song.trackName}" class="w-16 h-16 rounded-lg" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22%3E%3Crect fill=%22%23ccc%22 width=%2260%22 height=%2260%22/%3E%3C/svg%3E'" />
                        <div class="flex-1 min-w-0">
                            <div class="text-white font-bold truncate">${song.trackName}</div>
                            <div class="text-white/80 text-sm truncate">${song.artistName}</div>
                        </div>
                        <button class="bg-cyan-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-cyan-600 transition-all">
                            â•
                        </button>
                    </div>
                `).join('')}
            `;
        }
        
        // å¹´ä»£åˆ¥ã‚¯ã‚¤ã‚ºï¼ˆãƒªãƒªãƒ¼ã‚¹å¹´ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼‰
        async function startDecadeQuiz(startYear, endYear) {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = `<p class="text-white text-center py-4">ğŸ” ${startYear}å¹´ä»£ã®æ›²ã‚’æ¤œç´¢ä¸­...</p>`;
            
            try {
                // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç‰ˆï¼šè¤‡æ•°ã®ã‚¯ã‚¨ãƒªã§å¹…åºƒãæ¤œç´¢ï¼ˆé‚¦æ¥½é™å®šï¼‰
                const searchQueries = [
                    `${startYear}å¹´ä»£ æ—¥æœ¬ ãƒ’ãƒƒãƒˆ`,
                    `${startYear} ${endYear} é‚¦æ¥½`,
                    `${startYear}s J-POP`,
                    `${startYear} ${endYear} æ—¥æœ¬ éŸ³æ¥½`,
                    `${Math.floor(startYear/10)*10}å¹´ä»£ æ—¥æœ¬ äººæ°—æ›²`
                ];
                
                let allSongs = [];
                
                // è¤‡æ•°ã®ã‚¯ã‚¨ãƒªã§æ¤œç´¢ï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç‰ˆã¯åˆ¶é™ãªã—ï¼‰
                for (let query of searchQueries) {
                    const url = `https://itunes.apple.com/search?term=${encodeURIComponent(query)}&media=music&limit=100&country=JP`;
                    const data = await fetchJsonp(url, 20000); // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ20ç§’
                    
                    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯èƒ½ãªæ›²ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                    const validSongs = data.results.filter(song => {
                        if (!song.previewUrl) return false;
                        
                        // releaseDate ãŒã‚ã‚Œã°å¹´ä»£ãƒã‚§ãƒƒã‚¯
                        if (song.releaseDate) {
                            const releaseYear = new Date(song.releaseDate).getFullYear();
                            return releaseYear >= startYear && releaseYear <= endYear;
                        }
                        
                        // releaseDate ãŒãªã„å ´åˆã¯å«ã‚ã‚‹ï¼ˆæ¤œç´¢ã‚¯ã‚¨ãƒªã§çµã£ã¦ã„ã‚‹ãŸã‚ï¼‰
                        return true;
                    });
                    
                    allSongs = allSongs.concat(validSongs);
                    console.log(`ã‚¯ã‚¨ãƒª "${query}": ${validSongs.length}æ›²`);
                }
                
                // é‡è¤‡ã‚’å‰Šé™¤
                const uniqueSongs = allSongs.filter((song, index, self) =>
                    index === self.findIndex(s => s.trackId === song.trackId)
                );
                
                console.log(`${startYear}å¹´ä»£ã®æ›²: ${uniqueSongs.length}æ›²è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);
                
                if (uniqueSongs.length === 0) {
                    alert(`${startYear}å¹´ä»£ã®æ›²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®å¹´ä»£ã‚’è©¦ã—ã¦ãã ã•ã„ã€‚`);
                    resultsDiv.innerHTML = '';
                    return;
                }
                
                // æ¤œç´¢çµæœã‚’è¡¨ç¤ºï¼ˆè¿½åŠ ãƒœã‚¿ãƒ³ä»˜ãï¼‰
                displayThemeResults(uniqueSongs, `${startYear}å¹´ä»£`);
                
            } catch (error) {
                console.error('å¹´ä»£æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                alert(`æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                resultsDiv.innerHTML = '';
            }
        }
        
        // ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåˆ¥ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹
        function startArtistQuiz(artistSongs) {
            // æ¤œç´¢çµæœã‚’è¡¨ç¤ºï¼ˆè¿½åŠ ãƒœã‚¿ãƒ³ä»˜ãï¼‰
            displayThemeResults(artistSongs, 'ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ');
        }

        // æ›²ã‚’è¿½åŠ 
        function addSong(song) {
            if (selectedSongs.find(s => s.trackId === song.trackId)) {
                alert('ã“ã®æ›²ã¯æ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™');
                return;
            }
            
            selectedSongs.push(song);
            updateSelectedSongsList();
        }

        // æ›²ã‚’å‰Šé™¤
        function removeSong(trackId) {
            selectedSongs = selectedSongs.filter(s => s.trackId !== trackId);
            updateSelectedSongsList();
        }

        // é¸æŠã—ãŸæ›²ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢
        function clearSelectedSongs() {
            if (selectedSongs.length === 0) {
                alert('é¸æŠã•ã‚Œã¦ã„ã‚‹æ›²ã¯ã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            if (confirm('é¸æŠã—ãŸæ›²ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                selectedSongs = [];
                localStorage.setItem('quizSelectedSongs', JSON.stringify(selectedSongs));
                updateSelectedSongsList();
            }
        }

        // é¸æŠã—ãŸæ›²ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        function updateSelectedSongsList() {
            // localStorageã«ä¿å­˜
            localStorage.setItem('quizSelectedSongs', JSON.stringify(selectedSongs));
            
            document.getElementById('songCount').textContent = selectedSongs.length;
            const listDiv = document.getElementById('selectedSongsList');
            
            if (selectedSongs.length === 0) {
                listDiv.innerHTML = '<p class="text-white/70 text-center py-4">æ›²ã‚’æ¤œç´¢ã—ã¦è¿½åŠ ã—ã¦ãã ã•ã„</p>';
                return;
            }
            
            listDiv.innerHTML = selectedSongs.map(song => `
                <div class="bg-white/20 rounded-xl p-3 flex items-center gap-3">
                    <img src="${song.artworkUrl60}" alt="${song.trackName}" class="w-12 h-12 rounded-lg" />
                    <div class="flex-1 min-w-0">
                        <div class="text-white font-bold truncate text-sm">${song.trackName}</div>
                        <div class="text-white/80 text-xs truncate">${song.artistName}</div>
                    </div>
                    <button 
                        onclick="removeSong(${song.trackId})"
                        class="bg-red-500/80 text-white px-3 py-1 rounded-lg font-bold hover:bg-red-600 transition-all text-sm"
                    >
                        âœ•
                    </button>
                </div>
            `).join('');
        }

        // å†ç”Ÿæ™‚é–“ã‚’æ›´æ–°
        function updateIntroLength(value) {
            introLength = parseInt(value);
            document.getElementById('introLengthValue').textContent = value;
        }

        // ã‚¯ã‚¤ã‚ºé–‹å§‹
        function startQuiz() {
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒ0äººã®å ´åˆã€è‡ªå‹•çš„ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
            if (players.length === 0) {
                const defaultPlayer = {id: Date.now(), name: 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1'};
                players.push(defaultPlayer);
                scores[defaultPlayer.id] = 0;
                savePlayers();
                saveScores();
                renderPlayerList();
            }
            
            if (selectedSongs.length === 0) {
                alert('æ›²ã‚’è¿½åŠ ã—ã¦ãã ã•ã„');
                return;
            }
            
            shuffleArray(selectedSongs);
            
            currentQuestionIndex = 0;
            document.getElementById('userManagement').classList.add('hidden');
            document.getElementById('quizGame').classList.remove('hidden');
            
            loadQuestion();
        }

        // å•é¡Œã‚’èª­ã¿è¾¼ã¿
        function loadQuestion() {
            const song = selectedSongs[currentQuestionIndex];
            
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQuestions').textContent = selectedSongs.length;
            document.getElementById('currentSongTitle').classList.add('hidden');
            document.getElementById('playFullBtn').classList.add('hidden');
            document.getElementById('timer').textContent = '0';
            
            // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’éè¡¨ç¤º
            document.getElementById('startMusicBtn').classList.remove('hidden');
            document.getElementById('musicControls').classList.add('hidden');
            
            const progress = ((currentQuestionIndex + 1) / selectedSongs.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            
            const buttonsDiv = document.getElementById('playerButtons');
            buttonsDiv.innerHTML = players.map(player => `
                <button 
                    onclick="answerQuestion(${player.id})"
                    class="glass-effect text-white px-6 py-6 rounded-xl font-bold text-xl hover:bg-white/30 transition-all transform hover:scale-105"
                >
                    <div class="text-3xl mb-2">ğŸ‘¤</div>
                    ${player.name}
                </button>
            `).join('');
            
            updateCurrentScores();
        }
        
        // éŸ³æ¥½ã‚’é–‹å§‹ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã§å‘¼ã°ã‚Œã‚‹ï¼‰
        function startMusic() {
            document.getElementById('startMusicBtn').classList.add('hidden');
            document.getElementById('musicControls').classList.remove('hidden');
            playIntro();
        }
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å†ç”Ÿ
        function playIntro() {
            const song = selectedSongs[currentQuestionIndex];
            audioPlayer.src = song.previewUrl;
            audioPlayer.currentTime = 0;
            audioPlayer.play();
            
            if (playbackTimer) {
                clearInterval(playbackTimer);
            }
            
            startTime = Date.now();
            playbackTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timer').textContent = elapsed;
                
                if (elapsed >= introLength) {
                    audioPlayer.pause();
                    clearInterval(playbackTimer);
                }
            }, 100);
        }
        
        // éŸ³æ¥½ã‚’åœæ­¢
        function stopAudio() {
            audioPlayer.pause();
            if (playbackTimer) {
                clearInterval(playbackTimer);
            }
        }
        
        // å…¨æ›²ã‚’å†ç”Ÿ
        function playFull() {
            const song = selectedSongs[currentQuestionIndex];
            audioPlayer.src = song.previewUrl;
            audioPlayer.currentTime = 0;
            audioPlayer.play();
            
            if (playbackTimer) {
                clearInterval(playbackTimer);
            }
        }

        // å›ç­”
        function answerQuestion(playerId) {
            stopAudio();
            
            const player = players.find(p => p.id === playerId);
            const song = selectedSongs[currentQuestionIndex];
            
            const userAnswer = confirm(`${player.name}ã•ã‚“ã€ã€Œ${song.trackName}ã€ã§æ­£è§£ã§ã™ã‹ï¼Ÿ`);
            
            if (userAnswer) {
                scores[playerId] = (scores[playerId] || 0) + 10;
                saveScores();
                updateCurrentScores(playerId);
                alert(`âœ… æ­£è§£ï¼ ${player.name}ã•ã‚“ã«10ãƒã‚¤ãƒ³ãƒˆï¼`);
            } else {
                alert(`âŒ ä¸æ­£è§£...`);
            }
            
            showAnswer();
        }

        // ç­”ãˆã‚’è¡¨ç¤º
        // ç­”ãˆã ã‘ã‚’è¡¨ç¤ºï¼ˆæ›²ã¯æµã•ãªã„ï¼‰
        function showAnswerOnly() {
            const song = selectedSongs[currentQuestionIndex];
            const titleElement = document.getElementById('currentSongTitle');
            titleElement.textContent = `â™ª ${song.trackName} - ${song.artistName}`;
            titleElement.classList.remove('hidden');
        }
        
        // ç­”ãˆã‚’è¡¨ç¤ºã—ã¦å…¨æ›²å†ç”Ÿ
        function playFullAnswer() {
            showAnswerOnly();
            document.getElementById('playFullBtn').classList.remove('hidden');
            playFull();
        }
        
        // æ—¢å­˜ã®showAnsweré–¢æ•°ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
        function showAnswer() {
            playFullAnswer();
        }

        // æ¬¡ã®å•é¡Œ
        function nextQuestion() {
            stopAudio();
            
            currentQuestionIndex++;
            
            if (currentQuestionIndex >= selectedSongs.length) {
                endQuiz();
            } else {
                loadQuestion();
            }
        }

        // ã‚¯ã‚¤ã‚ºçµ‚äº†
        function endQuiz() {
            stopAudio();
            
            document.getElementById('quizGame').classList.add('hidden');
            document.getElementById('userManagement').classList.remove('hidden');
            
            const sortedPlayers = [...players].sort((a, b) => (scores[b.id] || 0) - (scores[a.id] || 0));
            
            let resultMessage = 'ğŸ† æœ€çµ‚çµæœ ğŸ†\n\n';
            sortedPlayers.forEach((player, index) => {
                const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : 'ã€€';
                resultMessage += `${medal} ${player.name}: ${scores[player.id] || 0}ãƒã‚¤ãƒ³ãƒˆ\n`;
            });
            
            alert(resultMessage);
            renderPlayerList();
        }

        // ç¾åœ¨ã®ã‚¹ã‚³ã‚¢ã‚’æ›´æ–°
        function updateCurrentScores(updatedPlayerId = null) {
            const scoresDiv = document.getElementById('currentScores');
            const sortedPlayers = [...players].sort((a, b) => (scores[b.id] || 0) - (scores[a.id] || 0));
            
            scoresDiv.innerHTML = sortedPlayers.map((player, index) => {
                const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : '';
                const isUpdated = player.id === updatedPlayerId;
                return `
                    <div class="bg-white/20 rounded-xl p-3 text-center ${isUpdated ? 'score-update' : ''}">
                        <div class="text-2xl mb-1">${medal || 'ğŸ‘¤'}</div>
                        <div class="text-white font-bold text-sm truncate">${player.name}</div>
                        <div class="text-white font-black text-xl mt-1">${scores[player.id] || 0}pt</div>
                    </div>
                `;
            }).join('');
        }

        // æˆç¸¾ãƒªã‚»ãƒƒãƒˆ
        function resetScores() {
            if (!confirm('å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æˆç¸¾ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            Object.keys(scores).forEach(key => {
                scores[key] = 0;
            });
            
            saveScores();
            renderPlayerList();
            alert('âœ… æˆç¸¾ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function savePlayers() {
            localStorage.setItem('quizPlayers', JSON.stringify(players));
        }

        function saveScores() {
            localStorage.setItem('quizScores', JSON.stringify(scores));
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        // æ›²ãƒªã‚¹ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜
        function saveSongList() {
            if (selectedSongs.length === 0) {
                alert('ä¿å­˜ã™ã‚‹æ›²ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const data = {
                version: '1.0',
                savedAt: new Date().toISOString(),
                songCount: selectedSongs.length,
                songs: selectedSongs
            };
            
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `quiz-songs-${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`âœ… ${selectedSongs.length}æ›²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼`);
        }
        
        // æ›²ãƒªã‚¹ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚€
        function loadSongList(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.songs || !Array.isArray(data.songs)) {
                        throw new Error('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™');
                    }
                    
                    // æ—¢å­˜ã®æ›²ãŒã‚ã‚‹å ´åˆã¯ç¢ºèª
                    if (selectedSongs.length > 0) {
                        if (!confirm(`ç¾åœ¨${selectedSongs.length}æ›²ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã™ã€‚\n\nã€ŒOKã€â†’ ã‚¯ãƒªã‚¢ã—ã¦èª­ã¿è¾¼ã‚€\nã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€â†’ æ—¢å­˜ã®æ›²ã«è¿½åŠ `)) {
                            // æ—¢å­˜ã®æ›²ã«è¿½åŠ 
                            data.songs.forEach(song => {
                                if (!selectedSongs.find(s => s.trackId === song.trackId)) {
                                    selectedSongs.push(song);
                                }
                            });
                        } else {
                            // ã‚¯ãƒªã‚¢ã—ã¦èª­ã¿è¾¼ã‚€
                            selectedSongs = data.songs;
                        }
                    } else {
                        selectedSongs = data.songs;
                    }
                    
                    localStorage.setItem('quizSelectedSongs', JSON.stringify(selectedSongs));
                    updateSelectedSongsList();
                    
                    alert(`âœ… ${data.songs.length}æ›²ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼\nåˆè¨ˆ: ${selectedSongs.length}æ›²`);
                    
                } catch (error) {
                    console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    alert('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆåŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦é¸æŠã§ãã‚‹ã‚ˆã†ã«ï¼‰
            event.target.value = '';
        }
    </script>
</body>
</html>