<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>æ›²å½“ã¦ã‚¯ã‚¤ã‚º - ãƒ¢ãƒã‚¤ãƒ«ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .gradient-cyan-teal {
            background: linear-gradient(135deg, #06b6d4 0%, #14b8a6 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        input, button {
            font-size: 16px !important;
        }
        .mobile-btn {
            min-height: 60px;
            min-width: 60px;
        }
    </style>
</head>
<body class="gradient-cyan-teal min-h-screen">
    <audio id="audioPlayer" preload="auto"></audio>
    
    <div class="container mx-auto px-3 py-4 max-w-2xl pb-20">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-black text-white mb-2 drop-shadow-lg">ğŸµ æ›²å½“ã¦ã‚¯ã‚¤ã‚º</h1>
            <p class="text-base text-white/90 drop-shadow">ãƒ¢ãƒã‚¤ãƒ«ç‰ˆ (JSONPå¯¾å¿œ)</p>
        </header>

        <div id="app">
            <div id="userManagement" class="space-y-5">
                <div class="glass-effect rounded-3xl p-5 shadow-2xl">
                    <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
                        <span class="text-3xl">ğŸ‘¥</span>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
                    </h2>
                    <div class="mb-4 flex gap-2">
                        <input type="text" id="playerName" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å" class="flex-1 px-4 py-3 rounded-xl focus:outline-none"/>
                        <button onclick="addPlayer()" class="bg-white text-cyan-600 px-6 py-3 rounded-xl font-bold mobile-btn">è¿½åŠ </button>
                    </div>
                    <div id="playerList" class="space-y-2"></div>
                    <button onclick="resetScores()" class="mt-4 w-full bg-red-500/80 text-white px-6 py-3 rounded-xl font-bold mobile-btn">ğŸ”„ å…¨æˆç¸¾ãƒªã‚»ãƒƒãƒˆ</button>
                </div>

                <div class="glass-effect rounded-3xl p-5 shadow-2xl">
                    <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
                        <span class="text-3xl">ğŸµ</span>æ›²ã‚’è¿½åŠ 
                    </h2>
                    <div class="mb-4 grid grid-cols-2 gap-2">
                        <button id="artistSearchBtn" onclick="setSearchType('artist')" class="bg-white/30 text-white px-4 py-3 rounded-xl font-bold mobile-btn">ğŸ‘¤ ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</button>
                        <button id="songSearchBtn" onclick="setSearchType('song')" class="bg-white/20 text-white px-4 py-3 rounded-xl font-bold mobile-btn">ğŸµ æ›²å</button>
                    </div>
                    <div class="mb-4 flex gap-2">
                        <input type="text" id="searchQuery" placeholder="ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã‚’å…¥åŠ›" class="flex-1 px-4 py-3 rounded-xl focus:outline-none"/>
                        <button onclick="searchSongs()" class="bg-white text-cyan-600 px-6 py-3 rounded-xl font-bold mobile-btn">ğŸ”</button>
                    </div>
                    
                    <div class="mb-5">
                        <h3 class="text-white font-bold mb-2">ğŸ“… å¹´ä»£åˆ¥J-POP</h3>
                        <div class="grid grid-cols-2 gap-2 mb-3">
                            <button onclick="startThemeQuiz('1980 1989 æ—¥æœ¬ ãƒ’ãƒƒãƒˆæ›²')" class="bg-gradient-to-r from-pink-500 to-rose-500 text-white px-3 py-3 rounded-xl font-bold mobile-btn text-sm">ğŸ¸ 80å¹´ä»£</button>
                            <button onclick="startThemeQuiz('1990 1999 æ—¥æœ¬ ãƒ’ãƒƒãƒˆæ›²')" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-3 py-3 rounded-xl font-bold mobile-btn text-sm">ğŸ’¿ 90å¹´ä»£</button>
                            <button onclick="startThemeQuiz('2000 2009 æ—¥æœ¬ ãƒ’ãƒƒãƒˆæ›²')" class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-3 py-3 rounded-xl font-bold mobile-btn text-sm">ğŸµ 2000å¹´ä»£</button>
                            <button onclick="startThemeQuiz('2010 2019 æ—¥æœ¬ ãƒ’ãƒƒãƒˆæ›²')" class="bg-gradient-to-r from-blue-500 to-cyan-500 text-white px-3 py-3 rounded-xl font-bold mobile-btn text-sm">ğŸ¤ 2010å¹´ä»£</button>
                            <button onclick="startThemeQuiz('2020 æ—¥æœ¬ æœ€æ–° ãƒ’ãƒƒãƒˆæ›²')" class="bg-gradient-to-r from-cyan-500 to-teal-500 text-white px-3 py-3 rounded-xl font-bold mobile-btn text-sm">ğŸŒŸ 2020å¹´ä»£</button>
                        </div>
                        <h3 class="text-white font-bold mb-2">ğŸ­ ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="startThemeQuiz('ã‚¢ãƒ‹ãƒ¡ã‚½ãƒ³ã‚° äººæ°—')" class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-3 py-3 rounded-xl font-bold mobile-btn text-sm">ğŸ¬ ã‚¢ãƒ‹ãƒ¡</button>
                            <button onclick="startThemeQuiz('æ´‹æ¥½ ãƒ’ãƒƒãƒˆæ›²')" class="bg-gradient-to-r from-green-500 to-emerald-500 text-white px-3 py-3 rounded-xl font-bold mobile-btn text-sm">ğŸŒ æ´‹æ¥½</button>
                            <button onclick="startThemeQuiz('ç«¥è¬¡ æ—¥æœ¬ å­ä¾›ã®æ­Œ')" class="bg-gradient-to-r from-yellow-400 to-amber-500 text-white px-3 py-3 rounded-xl font-bold mobile-btn text-sm">ğŸ‘¶ ç«¥è¬¡</button>
                        </div>
                    </div>
                    
                    <div id="searchResults" class="space-y-2 mb-4 max-h-80 overflow-y-auto"></div>
                    <h3 class="text-lg font-bold text-white mb-2 mt-5">é¸æŠã—ãŸæ›²ï¼ˆ<span id="songCount">0</span>æ›²ï¼‰</h3>
                    <div id="selectedSongsList" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>

                <div class="glass-effect rounded-3xl p-5 shadow-2xl">
                    <h2 class="text-2xl font-bold text-white mb-4">âš™ï¸ è¨­å®š</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-white font-bold mb-2">å†ç”Ÿæ™‚é–“: <span id="introLengthValue">3</span>ç§’</label>
                            <input type="range" id="introLength" min="1" max="10" value="3" oninput="updateIntroLength(this.value)" class="w-full h-3 bg-white/30 rounded-lg"/>
                        </div>
                    </div>
                    <button onclick="startQuiz()" class="mt-5 w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-6 py-4 rounded-xl font-black text-xl mobile-btn">ğŸ® ã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
                </div>
            </div>

            <div id="quizGame" class="hidden space-y-5">
                <div class="glass-effect rounded-3xl p-5 shadow-2xl">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-white font-bold text-lg">å•é¡Œ <span id="currentQuestion">1</span> / <span id="totalQuestions">10</span></span>
                        <span class="text-white font-bold text-lg">â±ï¸ <span id="timer">0</span>ç§’</span>
                    </div>
                    <div class="w-full bg-white/30 rounded-full h-3">
                        <div id="progressBar" class="bg-yellow-400 h-3 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                </div>

                <div class="glass-effect rounded-3xl p-6 shadow-2xl text-center">
                    <div class="text-5xl mb-3">ğŸµ</div>
                    <h3 class="text-2xl font-black text-white mb-4">ã“ã®æ›²ã¯ä½•ã§ã—ã‚‡ã†ï¼Ÿ</h3>
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <button onclick="playIntro()" class="bg-green-500 text-white px-4 py-3 rounded-xl font-bold mobile-btn">ğŸ”Š<br>å†ç”Ÿ</button>
                        <button onclick="stopAudio()" class="bg-red-500 text-white px-4 py-3 rounded-xl font-bold mobile-btn">â¸ï¸<br>åœæ­¢</button>
                        <button id="playFullBtn" onclick="playFull()" class="bg-blue-500 text-white px-4 py-3 rounded-xl font-bold mobile-btn hidden">ğŸµ<br>å…¨æ›²</button>
                    </div>
                    <p id="currentSongTitle" class="text-xl text-white font-bold hidden mt-3"></p>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div id="playerButtons"></div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button onclick="showAnswer()" class="glass-effect text-white px-5 py-4 rounded-xl font-bold mobile-btn">ğŸ’¡ ç­”ãˆè¡¨ç¤º</button>
                    <button onclick="nextQuestion()" class="bg-white text-cyan-600 px-5 py-4 rounded-xl font-bold mobile-btn">â¡ï¸ æ¬¡ã®å•é¡Œ</button>
                </div>

                <div class="glass-effect rounded-3xl p-5 shadow-2xl">
                    <h3 class="text-xl font-bold text-white mb-3">ğŸ“Š ã‚¹ã‚³ã‚¢</h3>
                    <div id="currentScores" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let players = JSON.parse(localStorage.getItem('quizPlayers') || '[]');
        let scores = JSON.parse(localStorage.getItem('quizScores') || '{}');
        let selectedSongs = [];
        let currentQuestionIndex = 0;
        let introLength = 3;
        let audioPlayer = document.getElementById('audioPlayer');
        let playbackTimer = null;
        let startTime = 0;
        let searchType = 'artist';

        renderPlayerList();
        setSearchType('artist');

        // JSONPæ–¹å¼ã§iTunes APIã«ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆiPhone Safariç¢ºå®Ÿå¯¾å¿œãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå»¶é•·ï¼‰
        function fetchJsonp(url, timeout = 60000) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_' + Date.now() + '_' + Math.random().toString(36).substr(2);
                const script = document.createElement('script');
                let timeoutId;

                window[callbackName] = function(data) {
                    clearTimeout(timeoutId);
                    delete window[callbackName];
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    resolve(data);
                };

                timeoutId = setTimeout(() => {
                    delete window[callbackName];
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    reject(new Error('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ60ç§’ï¼‰'));
                }, timeout);

                script.onerror = () => {
                    clearTimeout(timeoutId);
                    delete window[callbackName];
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    reject(new Error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'));
                };

                script.src = url + '&callback=' + callbackName;
                document.head.appendChild(script);
            });
        }

        function setSearchType(type) {
            searchType = type;
            const artistBtn = document.getElementById('artistSearchBtn');
            const songBtn = document.getElementById('songSearchBtn');
            const searchInput = document.getElementById('searchQuery');
            
            if (type === 'artist') {
                artistBtn.classList.remove('bg-white/20');
                artistBtn.classList.add('bg-white/30');
                songBtn.classList.remove('bg-white/30');
                songBtn.classList.add('bg-white/20');
                searchInput.placeholder = 'ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã‚’å…¥åŠ›';
            } else {
                songBtn.classList.remove('bg-white/20');
                songBtn.classList.add('bg-white/30');
                artistBtn.classList.remove('bg-white/30');
                artistBtn.classList.add('bg-white/20');
                searchInput.placeholder = 'æ›²åã‚’å…¥åŠ›';
            }
            document.getElementById('searchResults').innerHTML = '';
        }

        async function searchSongs() {
            const query = document.getElementById('searchQuery').value.trim();
            if (!query) {
                alert('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<p class="text-white text-center py-4">ğŸ” æ¤œç´¢ä¸­...</p>';
            
            try {
                // æ¤œç´¢ä»¶æ•°ã‚’30ä»¶ã«åˆ¶é™ï¼ˆæ›²æ•°ãŒå¤šã„ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆå¯¾ç­–ï¼‰
                const url = `https://itunes.apple.com/search?term=${encodeURIComponent(query)}&media=music&limit=30`;
                const data = await fetchJsonp(url);
                
                if (!data.results || data.results.length === 0) {
                    resultsDiv.innerHTML = '<p class="text-white text-center py-4 text-sm">æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }
                
                const songsWithPreview = data.results.filter(song => song.previewUrl);
                
                if (songsWithPreview.length === 0) {
                    resultsDiv.innerHTML = '<p class="text-white text-center py-4 text-sm">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯èƒ½ãªæ›²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
                    return;
                }
                
                if (searchType === 'artist') {
                    displayArtistResults(songsWithPreview);
                } else {
                    displaySongResults(songsWithPreview);
                }
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="bg-red-500/30 rounded-xl p-3 text-white text-sm"><p class="font-bold">âŒ æ¤œç´¢å¤±æ•—</p><p class="text-xs">${error.message}</p><button onclick="searchSongs()" class="mt-2 w-full bg-white/20 px-3 py-2 rounded-lg font-bold">ğŸ”„ å†è©¦è¡Œ</button></div>`;
            }
        }

        function displayArtistResults(songs) {
            const resultsDiv = document.getElementById('searchResults');
            const searchQuery = document.getElementById('searchQuery').value.trim().toLowerCase();
            
            const artistMap = {};
            songs.forEach(song => {
                if (song.artistName.toLowerCase().includes(searchQuery)) {
                    if (!artistMap[song.artistId]) {
                        artistMap[song.artistId] = {artistName: song.artistName, artistId: song.artistId, songs: []};
                    }
                    artistMap[song.artistId].songs.push(song);
                }
            });
            
            const artists = Object.values(artistMap);
            if (artists.length === 0) {
                resultsDiv.innerHTML = '<p class="text-white text-center py-4 text-sm">è©²å½“ã™ã‚‹ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
                return;
            }
            
            artists.sort((a, b) => b.songs.length - a.songs.length);
            
            resultsDiv.innerHTML = artists.map(artist => `
                <div class="bg-white/20 rounded-xl p-3 mb-2">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex-1 min-w-0">
                            <div class="text-white font-bold text-sm truncate">ğŸ‘¤ ${artist.artistName}</div>
                            <div class="text-white/80 text-xs">${artist.songs.length}æ›²</div>
                        </div>
                        <button onclick='startArtistQuiz(${JSON.stringify(artist.songs).replace(/'/g, "&#39;")})' class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-3 py-2 rounded-lg font-bold text-xs">ğŸ® ã‚¯ã‚¤ã‚º</button>
                    </div>
                    <details class="mt-2">
                        <summary class="text-white/90 cursor-pointer text-xs font-bold mb-2">ğŸ“‹ æ›²ä¸€è¦§ï¼ˆ${artist.songs.length}æ›²ï¼‰</summary>
                        <div class="mt-2 space-y-1 max-h-48 overflow-y-auto">
                            ${artist.songs.map(song => `
                                <div class="bg-white/10 rounded-lg p-2 flex items-center gap-2">
                                    <img src="${song.artworkUrl60}" alt="" class="w-10 h-10 rounded"/>
                                    <div class="flex-1 min-w-0"><div class="text-white font-bold text-xs truncate">${song.trackName}</div></div>
                                    <button onclick='addSong(${JSON.stringify(song).replace(/'/g, "&#39;")})' class="bg-cyan-500 text-white px-2 py-1 rounded-lg font-bold text-xs">â•</button>
                                </div>
                            `).join('')}
                        </div>
                    </details>
                </div>
            `).join('');
        }

        function displaySongResults(songs) {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = songs.map(song => `
                <div class="bg-white/20 rounded-xl p-2 flex items-center gap-2" onclick='addSong(${JSON.stringify(song).replace(/'/g, "&#39;")})'>
                    <img src="${song.artworkUrl60}" alt="" class="w-12 h-12 rounded-lg"/>
                    <div class="flex-1 min-w-0">
                        <div class="text-white font-bold text-sm truncate">${song.trackName}</div>
                        <div class="text-white/80 text-xs truncate">${song.artistName}</div>
                    </div>
                    <button class="bg-cyan-500 text-white px-3 py-2 rounded-lg font-bold text-xs">â•</button>
                </div>
            `).join('');
        }

        async function startThemeQuiz(theme) {
            if (players.length === 0) {
                alert('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ ã—ã¦ãã ã•ã„');
                return;
            }
            
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = `<p class="text-white text-center py-4 text-sm">ğŸ” ã€Œ${theme}ã€ã‚’æ¤œç´¢ä¸­...</p>`;
            
            try {
                // æ¤œç´¢ä»¶æ•°ã‚’30ä»¶ã«åˆ¶é™ï¼ˆå®‰å®šæ€§å‘ä¸Šï¼‰
                const url = `https://itunes.apple.com/search?term=${encodeURIComponent(theme)}&media=music&limit=30`;
                const data = await fetchJsonp(url);
                
                const songsWithPreview = data.results.filter(song => song.previewUrl);
                
                if (songsWithPreview.length === 0) {
                    alert('æ›²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                    resultsDiv.innerHTML = '';
                    return;
                }
                
                const numSongs = Math.min(10, songsWithPreview.length);
                selectedSongs = shuffleArray([...songsWithPreview]).slice(0, numSongs);
                updateSelectedSongsList();
                resultsDiv.innerHTML = `<p class="text-white text-center py-4 text-sm">âœ… ${selectedSongs.length}æ›²ã‚’é¸æŠï¼</p>`;
                setTimeout(startQuiz, 1000);
            } catch (error) {
                alert(`æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                resultsDiv.innerHTML = '';
            }
        }

        function startArtistQuiz(artistSongs) {
            if (players.length === 0) {
                alert('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ ã—ã¦ãã ã•ã„');
                return;
            }
            const numSongs = Math.min(10, artistSongs.length);
            selectedSongs = shuffleArray([...artistSongs]).slice(0, numSongs);
            updateSelectedSongsList();
            setTimeout(startQuiz, 500);
        }

        function addPlayer() {
            const nameInput = document.getElementById('playerName');
            const name = nameInput.value.trim();
            if (!name) {
                alert('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            if (players.length >= 4) {
                alert('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯æœ€å¤§4äººã¾ã§ã§ã™');
                return;
            }
            const player = {id: Date.now(), name: name};
            players.push(player);
            scores[player.id] = scores[player.id] || 0;
            savePlayers();
            saveScores();
            renderPlayerList();
            nameInput.value = '';
        }

        function removePlayer(id) {
            players = players.filter(p => p.id !== id);
            delete scores[id];
            savePlayers();
            saveScores();
            renderPlayerList();
        }

        function renderPlayerList() {
            const listDiv = document.getElementById('playerList');
            if (players.length === 0) {
                listDiv.innerHTML = '<p class="text-white/70 text-center py-3 text-sm">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>';
                return;
            }
            listDiv.innerHTML = players.map(player => `
                <div class="bg-white/20 rounded-xl p-3 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">ğŸ‘¤</span>
                        <div>
                            <div class="text-white font-bold">${player.name}</div>
                            <div class="text-white/80 text-sm">ã‚¹ã‚³ã‚¢: ${scores[player.id] || 0}pt</div>
                        </div>
                    </div>
                    <button onclick="removePlayer(${player.id})" class="bg-red-500/80 text-white px-3 py-2 rounded-lg font-bold">âœ•</button>
                </div>
            `).join('');
        }

        function addSong(song) {
            if (selectedSongs.find(s => s.trackId === song.trackId)) {
                alert('ã“ã®æ›²ã¯æ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™');
                return;
            }
            selectedSongs.push(song);
            updateSelectedSongsList();
        }

        function removeSong(trackId) {
            selectedSongs = selectedSongs.filter(s => s.trackId !== trackId);
            updateSelectedSongsList();
        }

        function updateSelectedSongsList() {
            document.getElementById('songCount').textContent = selectedSongs.length;
            const listDiv = document.getElementById('selectedSongsList');
            if (selectedSongs.length === 0) {
                listDiv.innerHTML = '<p class="text-white/70 text-center py-3 text-sm">æ›²ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>';
                return;
            }
            listDiv.innerHTML = selectedSongs.map(song => `
                <div class="bg-white/20 rounded-xl p-2 flex items-center gap-2">
                    <img src="${song.artworkUrl60}" alt="" class="w-10 h-10 rounded-lg"/>
                    <div class="flex-1 min-w-0">
                        <div class="text-white font-bold text-xs truncate">${song.trackName}</div>
                        <div class="text-white/80 text-xs truncate">${song.artistName}</div>
                    </div>
                    <button onclick="removeSong(${song.trackId})" class="bg-red-500/80 text-white px-2 py-1 rounded-lg font-bold text-xs">âœ•</button>
                </div>
            `).join('');
        }

        function updateIntroLength(value) {
            introLength = parseInt(value);
            document.getElementById('introLengthValue').textContent = value;
        }

        function startQuiz() {
            if (players.length === 0) {
                alert('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ ã—ã¦ãã ã•ã„');
                return;
            }
            if (selectedSongs.length === 0) {
                alert('æ›²ã‚’è¿½åŠ ã—ã¦ãã ã•ã„');
                return;
            }
            shuffleArray(selectedSongs);
            currentQuestionIndex = 0;
            document.getElementById('userManagement').classList.add('hidden');
            document.getElementById('quizGame').classList.remove('hidden');
            loadQuestion();
        }

        function loadQuestion() {
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQuestions').textContent = selectedSongs.length;
            document.getElementById('currentSongTitle').classList.add('hidden');
            document.getElementById('playFullBtn').classList.add('hidden');
            document.getElementById('timer').textContent = '0';
            
            const progress = ((currentQuestionIndex + 1) / selectedSongs.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            
            const buttonsDiv = document.getElementById('playerButtons');
            buttonsDiv.innerHTML = players.map(player => `
                <button onclick="answerQuestion(${player.id})" class="glass-effect text-white px-5 py-5 rounded-xl font-bold mobile-btn">
                    <div class="text-3xl mb-1">ğŸ‘¤</div>
                    <div class="text-sm">${player.name}</div>
                </button>
            `).join('');
            
            updateCurrentScores();
            playIntro();
        }

        function playIntro() {
            const song = selectedSongs[currentQuestionIndex];
            audioPlayer.src = song.previewUrl;
            audioPlayer.currentTime = 0;
            audioPlayer.play();
            
            if (playbackTimer) clearInterval(playbackTimer);
            
            startTime = Date.now();
            playbackTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timer').textContent = elapsed;
                if (elapsed >= introLength) {
                    audioPlayer.pause();
                    clearInterval(playbackTimer);
                }
            }, 100);
        }

        function stopAudio() {
            audioPlayer.pause();
            if (playbackTimer) clearInterval(playbackTimer);
        }

        function playFull() {
            const song = selectedSongs[currentQuestionIndex];
            audioPlayer.src = song.previewUrl;
            audioPlayer.currentTime = 0;
            audioPlayer.play();
            if (playbackTimer) clearInterval(playbackTimer);
        }

        function answerQuestion(playerId) {
            stopAudio();
            const player = players.find(p => p.id === playerId);
            const song = selectedSongs[currentQuestionIndex];
            const userAnswer = confirm(`${player.name}ã•ã‚“ã€ã€Œ${song.trackName}ã€ã§æ­£è§£ã§ã™ã‹ï¼Ÿ`);
            
            if (userAnswer) {
                scores[playerId] = (scores[playerId] || 0) + 10;
                saveScores();
                updateCurrentScores();
                alert(`âœ… æ­£è§£ï¼ ${player.name}ã•ã‚“ã«10ãƒã‚¤ãƒ³ãƒˆï¼`);
            } else {
                alert(`âŒ ä¸æ­£è§£...`);
            }
            showAnswer();
        }

        function showAnswer() {
            const song = selectedSongs[currentQuestionIndex];
            const titleElement = document.getElementById('currentSongTitle');
            titleElement.textContent = `â™ª ${song.trackName} - ${song.artistName}`;
            titleElement.classList.remove('hidden');
            document.getElementById('playFullBtn').classList.remove('hidden');
            playFull();
        }

        function nextQuestion() {
            stopAudio();
            currentQuestionIndex++;
            if (currentQuestionIndex >= selectedSongs.length) {
                endQuiz();
            } else {
                loadQuestion();
            }
        }

        function endQuiz() {
            stopAudio();
            document.getElementById('quizGame').classList.add('hidden');
            document.getElementById('userManagement').classList.remove('hidden');
            
            const sortedPlayers = [...players].sort((a, b) => (scores[b.id] || 0) - (scores[a.id] || 0));
            let resultMessage = 'ğŸ† æœ€çµ‚çµæœ ğŸ†\n\n';
            sortedPlayers.forEach((player, index) => {
                const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : 'ã€€';
                resultMessage += `${medal} ${player.name}: ${scores[player.id] || 0}ãƒã‚¤ãƒ³ãƒˆ\n`;
            });
            alert(resultMessage);
            renderPlayerList();
        }

        function updateCurrentScores() {
            const scoresDiv = document.getElementById('currentScores');
            const sortedPlayers = [...players].sort((a, b) => (scores[b.id] || 0) - (scores[a.id] || 0));
            scoresDiv.innerHTML = sortedPlayers.map((player, index) => {
                const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : 'ã€€';
                return `
                    <div class="bg-white/20 rounded-xl p-3 flex justify-between items-center">
                        <span class="text-white font-bold text-sm">${medal} ${player.name}</span>
                        <span class="text-white font-black text-lg">${scores[player.id] || 0}pt</span>
                    </div>
                `;
            }).join('');
        }

        function resetScores() {
            if (!confirm('å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æˆç¸¾ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
            Object.keys(scores).forEach(key => { scores[key] = 0; });
            saveScores();
            renderPlayerList();
            alert('âœ… æˆç¸¾ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
        }

        function savePlayers() {
            localStorage.setItem('quizPlayers', JSON.stringify(players));
        }

        function saveScores() {
            localStorage.setItem('quizScores', JSON.stringify(scores));
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
    </script>
</body>
</html>